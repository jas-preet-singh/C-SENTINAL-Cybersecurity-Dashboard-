{% extends "base.html" %}

{% block title %}Dashboard - CyberSec Dashboard{% endblock %}

{% block content %}
<div class="container">
    <!-- Welcome Section -->
    <div class="row mt-4 mb-5">
        <div class="col-12">
            <div class="welcome-card">
                <h2>
                    <i class="fas fa-tachometer-alt"></i> 
                    Welcome back, {{ current_user.first_name or 'User' }}!
                </h2>
                <p>Access powerful cybersecurity tools and analyze potential threats.</p>
            </div>
        </div>
    </div>
    
    <!-- Security Modules Grid -->
    <div class="row">
        <!-- Hash Calculator -->
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card module-card overview-card">
                <div class="card-body text-center">
                    <div class="module-icon-large">
                        <i class="fas fa-calculator"></i>
                    </div>
                    <h5 class="card-title">Hash Calculator</h5>
                    <p class="card-text">Generate secure hash values using multiple algorithms</p>
                    <button class="btn btn-primary btn-glow" onclick="openModule('hash')">
                        <i class="fas fa-external-link-alt"></i> Click to use
                    </button>
                </div>
            </div>
        </div>
        
        <!-- File Encryption -->
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card module-card overview-card">
                <div class="card-body text-center">
                    <div class="module-icon-large">
                        <i class="fas fa-lock"></i>
                    </div>
                    <h5 class="card-title">File Encrypt/Decrypt</h5>
                    <p class="card-text">Secure files with advanced encryption algorithms</p>
                    <button class="btn btn-primary btn-glow" onclick="openModule('encrypt')">
                        <i class="fas fa-external-link-alt"></i> Click to use
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Brute Force Simulator -->
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card module-card overview-card">
                <div class="card-body text-center">
                    <div class="module-icon-large">
                        <i class="fas fa-hammer"></i>
                    </div>
                    <h5 class="card-title">Brute Force Simulator</h5>
                    <p class="card-text">Demonstrate password vulnerability concepts</p>
                    <button class="btn btn-primary btn-glow" onclick="openModule('brute')">
                        <i class="fas fa-external-link-alt"></i> Click to use
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Hash Comparison -->
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card module-card overview-card">
                <div class="card-body text-center">
                    <div class="module-icon-large">
                        <i class="fas fa-balance-scale"></i>
                    </div>
                    <h5 class="card-title">Hash Comparison</h5>
                    <p class="card-text">Compare hash values to detect file changes</p>
                    <button class="btn btn-primary btn-glow" onclick="openModule('compare')">
                        <i class="fas fa-external-link-alt"></i> Click to use
                    </button>
                </div>
            </div>
        </div>
        
        <!-- URL & Malware Scanner -->
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card module-card overview-card">
                <div class="card-body text-center">
                    <div class="module-icon-large">
                        <i class="fas fa-globe"></i>
                    </div>
                    <h5 class="card-title">URL & Malware Scanner</h5>
                    <p class="card-text">Identify malicious URLs and phishing attempts</p>
                    <button class="btn btn-primary btn-glow" onclick="openModule('scanner')">
                        <i class="fas fa-external-link-alt"></i> Click to use
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Vulnerability Scanner -->
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card module-card overview-card">
                <div class="card-body text-center">
                    <div class="module-icon-large">
                        <i class="fas fa-bug"></i>
                    </div>
                    <h5 class="card-title">Vulnerability Scanner</h5>
                    <p class="card-text">Analyze websites for security vulnerabilities</p>
                    <button class="btn btn-primary btn-glow" onclick="openModule('vuln')">
                        <i class="fas fa-external-link-alt"></i> Click to use
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Password Strength Analyzer -->
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card module-card overview-card">
                <div class="card-body text-center">
                    <div class="module-icon-large">
                        <i class="fas fa-key"></i>
                    </div>
                    <h5 class="card-title">Password Strength Analyzer</h5>
                    <p class="card-text">Analyze password security and get strength recommendations</p>
                    <button class="btn btn-primary btn-glow" onclick="openModule('password')">
                        <i class="fas fa-external-link-alt"></i> Click to use
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Activity -->
    <div class="row mt-5">
        <div class="col-lg-6 mb-4">
            <div class="card activity-card">
                <div class="card-header">
                    <h6><i class="fas fa-clock"></i> Recent Jobs</h6>
                </div>
                <div class="card-body">
                    {% if recent_jobs %}
                        <div class="activity-list">
                            {% for job in recent_jobs %}
                            <div class="activity-item">
                                <div class="activity-icon">
                                    <i class="fas fa-{{ 'check' if job.status == 'completed' else 'clock' if job.status == 'running' else 'times' }}"></i>
                                </div>
                                <div class="activity-details">
                                    <strong>{{ job.job_type.replace('_', ' ').title() }}</strong>
                                    <small class="d-block text-muted">{{ job.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                                    <span class="badge bg-{{ 'success' if job.status == 'completed' else 'warning' if job.status == 'running' else 'danger' }}">
                                        {{ job.status.title() }}
                                    </span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted text-center">No recent jobs</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-lg-6 mb-4">
            <div class="card activity-card">
                <div class="card-header">
                    <h6><i class="fas fa-shield-alt"></i> Recent Scans</h6>
                </div>
                <div class="card-body">
                    {% if recent_scans %}
                        <div class="activity-list">
                            {% for scan in recent_scans %}
                            <div class="activity-item">
                                <div class="activity-icon">
                                    <i class="fas fa-{{ 'shield-alt' if scan.risk_level == 'low' else 'exclamation-triangle' if scan.risk_level == 'medium' else 'skull-crossbones' }}"></i>
                                </div>
                                <div class="activity-details">
                                    <strong>{{ scan.scan_type.title() }} Scan</strong>
                                    <small class="d-block text-muted">{{ scan.target[:50] }}{% if scan.target|length > 50 %}...{% endif %}</small>
                                    <span class="badge bg-{{ 'success' if scan.risk_level == 'low' else 'warning' if scan.risk_level == 'medium' else 'danger' }}">
                                        {{ scan.risk_level.title() }} Risk
                                    </span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted text-center">No recent scans</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Module Modals -->
<div id="moduleModalContainer"></div>
<script>
// Wait for everything to load
document.addEventListener('DOMContentLoaded', function() {
    console.log('Dashboard loaded successfully');
});

function confirmLegality() {
    return confirm("I confirm that I own this file or have explicit permission to attempt password recovery. Unauthorized access is illegal and may result in criminal charges.");
}

function confirmEthicalUse() {
    return confirm("I confirm that I own this website or have explicit written permission to perform security testing. Unauthorized scanning may be illegal.");
}

function openModule(moduleType) {
    // Wait for DOM to be ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            openModule(moduleType);
        });
        return;
    }
    
    const modalContainer = document.getElementById('moduleModalContainer');
    if (!modalContainer) {
        console.error('Modal container not found');
        return;
    }
    
    const modalContent = getModalContent(moduleType);
    modalContainer.innerHTML = modalContent;
    
    const modalElement = document.getElementById('moduleModal');
    if (!modalElement) {
        console.error('Modal element not found');
        return;
    }
    
    const modal = new bootstrap.Modal(modalElement);
    modal.show();
    
    // Clean up when modal is hidden
    modalElement.addEventListener('hidden.bs.modal', function() {
        modalContainer.innerHTML = '';
    }, { once: true });
}

function getModalContent(moduleType) {
    const modals = {
        hash: `
            <div class="modal fade" id="moduleModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content" style="background: rgba(26, 26, 26, 0.95); border: 1px solid var(--accent-green);">
                        <div class="modal-header">
                            <h5 class="modal-title text-white"><i class="fas fa-hash"></i> Hash Calculator</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="education-info mb-3">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle"></i>
                                    Generate cryptographic hashes (MD5, SHA-1, SHA-256, SHA-512) for data integrity verification.
                                </small>
                            </div>
                            <form method="POST" action="{{ url_for('hash_calculator') }}" enctype="multipart/form-data">
                                <div class="mb-3">
                                    <label class="form-label">Hash Type</label>
                                    <select name="hash_type" class="form-select">
                                        <option value="md5">MD5</option>
                                        <option value="sha1">SHA-1</option>
                                        <option value="sha256" selected>SHA-256</option>
                                        <option value="sha512">SHA-512</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Input Text</label>
                                    <textarea name="text" class="form-control" rows="2" placeholder="Enter text to hash..."></textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Or Upload File</label>
                                    <input type="file" name="file" class="form-control">
                                </div>
                                <button type="submit" class="btn btn-primary btn-glow w-100">
                                    <i class="fas fa-calculator"></i> Calculate Hash
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>`,
        
        encrypt: `
            <div class="modal fade" id="moduleModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content" style="background: rgba(26, 26, 26, 0.95); border: 1px solid var(--accent-green);">
                        <div class="modal-header">
                            <h5 class="modal-title text-white"><i class="fas fa-lock"></i> File Encrypt/Decrypt</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="education-info mb-3">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle"></i>
                                    Secure files using AES encryption with password-based key derivation (PBKDF2).
                                </small>
                            </div>
                            <form method="POST" action="{{ url_for('encrypt') }}" enctype="multipart/form-data">
                                <h6 class="text-center mb-3 text-success">Encrypt File</h6>
                                <div class="mb-3">
                                    <label class="form-label">File to Encrypt</label>
                                    <input type="file" name="file" class="form-control" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Encryption Password</label>
                                    <input type="password" name="password" class="form-control" required>
                                </div>
                                <button type="submit" class="btn btn-success btn-glow w-100 mb-3">
                                    <i class="fas fa-shield-alt"></i> Encrypt File
                                </button>
                            </form>
                            <hr>
                            <form method="POST" action="{{ url_for('decrypt') }}" enctype="multipart/form-data">
                                <h6 class="text-center mb-3 text-warning">Decrypt File</h6>
                                <div class="mb-3">
                                    <label class="form-label">Encrypted File</label>
                                    <input type="file" name="file" class="form-control" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Decryption Password</label>
                                    <input type="password" name="password" class="form-control" required>
                                </div>
                                <button type="submit" class="btn btn-warning btn-glow w-100">
                                    <i class="fas fa-unlock"></i> Decrypt File
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>`,
        
        brute: `
            <div class="modal fade" id="moduleModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content" style="background: rgba(26, 26, 26, 0.95); border: 1px solid var(--accent-green);">
                        <div class="modal-header">
                            <h5 class="modal-title text-white"><i class="fas fa-hammer"></i> Brute Force Simulator</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-danger alert-sm">
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>Legal Notice:</strong> Only use on files you own or have explicit permission to test.
                            </div>
                            <div class="education-info mb-3">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle"></i>
                                    Attempt brute force attacks on protected files (PDF, ZIP, Office documents) for password recovery.
                                </small>
                            </div>
                            <form id="bruteForceForm" method="POST" action="{{ url_for('start_brute') }}" enctype="multipart/form-data" onsubmit="return startBruteForce(event)">
                                <div class="mb-3">
                                    <label class="form-label">Protected File</label>
                                    <input type="file" name="file" class="form-control" accept=".pdf,.zip,.docx,.pptx,.xlsx" required>
                                    <small class="form-text">Supports: PDF, ZIP, DOCX, PPTX, XLSX</small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Wordlist Type</label>
                                    <select name="wordlist" class="form-select" id="wordlistSelect" onchange="toggleWordlistUpload()">
                                        <option value="common">Common Passwords</option>
                                        <option value="numbers">Numeric (0000-9999)</option>
                                        <option value="years">Years (1900-2029)</option>
                                        <option value="custom">Custom Wordlist File</option>
                                    </select>
                                </div>
                                <div class="mb-3" id="customWordlistDiv" style="display: none;">
                                    <label class="form-label">Custom Wordlist File</label>
                                    <input type="file" name="wordlist_file" class="form-control" accept=".txt">
                                    <small class="form-text">Upload a text file with one password per line</small>
                                </div>
                                <button type="submit" class="btn btn-danger btn-glow w-100" id="startBruteBtn">
                                    <i class="fas fa-hammer"></i> Start Brute Force
                                </button>
                            </form>
                            
                            <!-- Progress Display -->
                            <div id="bruteProgress" style="display: none;" class="mt-4">
                                <h6 class="text-warning"><i class="fas fa-cog fa-spin"></i> Brute Force in Progress</h6>
                                <div class="progress mb-3">
                                    <div id="progressBar" class="progress-bar bg-warning" role="progressbar" style="width: 0%"></div>
                                </div>
                                <div class="row">
                                    <div class="col-6">
                                        <small class="text-muted">Progress:</small>
                                        <div id="progressText">0%</div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Current Password:</small>
                                        <div id="currentPassword">-</div>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted">Status:</small>
                                    <div id="statusText">Running...</div>
                                </div>
                                <button type="button" class="btn btn-secondary btn-sm mt-3" onclick="cancelBruteForce()">
                                    <i class="fas fa-stop"></i> Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`,
        
        compare: `
            <div class="modal fade" id="moduleModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content" style="background: rgba(26, 26, 26, 0.95); border: 1px solid var(--accent-green);">
                        <div class="modal-header">
                            <h5 class="modal-title text-white"><i class="fas fa-balance-scale"></i> Hash Comparison</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="education-info mb-3">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle"></i>
                                    Compare cryptographic hashes of two files to verify integrity and detect tampering.
                                </small>
                            </div>
                            <form method="POST" action="{{ url_for('compare') }}" enctype="multipart/form-data">
                                <div class="mb-3">
                                    <label class="form-label">Hash Type</label>
                                    <select name="hash_type" class="form-select">
                                        <option value="md5">MD5</option>
                                        <option value="sha1">SHA-1</option>
                                        <option value="sha256" selected>SHA-256</option>
                                        <option value="sha512">SHA-512</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">First File</label>
                                    <input type="file" name="file1" class="form-control" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Second File</label>
                                    <input type="file" name="file2" class="form-control" required>
                                </div>
                                <button type="submit" class="btn btn-info btn-glow w-100">
                                    <i class="fas fa-equals"></i> Compare Hashes
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>`,
        
        scanner: `
            <div class="modal fade" id="moduleModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content" style="background: rgba(26, 26, 26, 0.95); border: 1px solid var(--accent-green);">
                        <div class="modal-header">
                            <h5 class="modal-title text-white"><i class="fas fa-globe"></i> URL & Malware Scanner</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="education-info mb-3">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle"></i>
                                    Scan URLs for safety and files for malware signatures using basic detection algorithms.
                                </small>
                            </div>
                            <form method="POST" action="{{ url_for('scan_url_route') }}">
                                <h6 class="text-center mb-3 text-warning">URL Scanner</h6>
                                <div class="mb-3">
                                    <label class="form-label">URL to Scan</label>
                                    <input type="url" name="url" class="form-control" placeholder="https://example.com" required>
                                </div>
                                <button type="submit" class="btn btn-warning btn-glow w-100 mb-3">
                                    <i class="fas fa-search"></i> Scan URL
                                </button>
                            </form>
                            <hr>
                            <form method="POST" action="{{ url_for('scan_file_route') }}" enctype="multipart/form-data">
                                <h6 class="text-center mb-3 text-danger">File Scanner</h6>
                                <div class="mb-3">
                                    <label class="form-label">File to Scan</label>
                                    <input type="file" name="file" class="form-control" required>
                                </div>
                                <button type="submit" class="btn btn-danger btn-glow w-100">
                                    <i class="fas fa-virus"></i> Scan for Malware
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>`,
        
        vuln: `
            <div class="modal fade" id="moduleModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content" style="background: rgba(26, 26, 26, 0.95); border: 1px solid var(--accent-green);">
                        <div class="modal-header">
                            <h5 class="modal-title text-white"><i class="fas fa-bug"></i> Vulnerability Scanner</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-warning alert-sm">
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>Ethical Use:</strong> Only scan websites you own or have explicit permission to test.
                            </div>
                            <div class="education-info mb-3">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle"></i>
                                    Test websites for common vulnerabilities like SQL injection, XSS, and missing security headers.
                                </small>
                            </div>
                            <form method="POST" action="{{ url_for('vulnerability_scan_route') }}" onsubmit="return confirmEthicalUse()">
                                <div class="mb-3">
                                    <label class="form-label">Target URL</label>
                                    <input type="url" name="url" class="form-control" placeholder="https://target.com" required>
                                </div>
                                <button type="submit" class="btn btn-dark btn-glow w-100">
                                    <i class="fas fa-search-plus"></i> Scan Vulnerabilities
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>`,
        
        password: `
            <div class="modal fade" id="moduleModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content" style="background: rgba(26, 26, 26, 0.95); border: 1px solid var(--accent-green);">
                        <div class="modal-header">
                            <h5 class="modal-title text-white"><i class="fas fa-shield-check"></i> Password Strength Analyzer</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="education-info mb-3">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle"></i>
                                    Analyze password security, entropy, patterns, and get detailed strength recommendations.
                                </small>
                            </div>
                            <form id="passwordAnalyzerForm" onsubmit="return analyzePassword(event)">
                                <div class="mb-3">
                                    <label class="form-label">Password to Analyze</label>
                                    <div class="input-group">
                                        <input type="password" id="passwordInput" name="password" class="form-control" placeholder="Enter password..." required>
                                        <button type="button" class="btn btn-outline-secondary" onclick="togglePasswordVisibility()">
                                            <i id="toggleIcon" class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <small class="form-text">Your password is analyzed locally and not stored</small>
                                </div>
                                <button type="submit" class="btn btn-success btn-glow w-100">
                                    <i class="fas fa-check-circle"></i> Analyze Strength
                                </button>
                            </form>
                            
                            <!-- Analysis Results -->
                            <div id="analysisResults" style="display: none;" class="mt-4">
                                <div class="card" style="background: rgba(0, 0, 0, 0.3); border: 1px solid var(--accent-green);">
                                    <div class="card-header">
                                        <h6><i class="fas fa-chart-bar"></i> Strength Analysis</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row mb-3">
                                            <div class="col-6">
                                                <div class="text-center">
                                                    <h2 id="strengthScore" class="text-success">0</h2>
                                                    <small class="text-muted">Security Score</small>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="text-center">
                                                    <h5 id="strengthLevel" class="text-success">Very Strong</h5>
                                                    <small class="text-muted">Strength Level</small>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="progress mb-3">
                                            <div id="strengthBar" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h6><i class="fas fa-info-circle"></i> Details</h6>
                                                <ul id="detailsList" class="list-unstyled">
                                                </ul>
                                            </div>
                                            <div class="col-md-6">
                                                <h6><i class="fas fa-exclamation-triangle"></i> Feedback</h6>
                                                <ul id="feedbackList" class="list-unstyled">
                                                </ul>
                                            </div>
                                        </div>
                                        
                                        <div class="mt-3">
                                            <h6><i class="fas fa-clock"></i> Estimated Crack Time</h6>
                                            <p id="crackTime" class="text-warning">-</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Password Suggestions -->
                                <div class="card mt-3" style="background: rgba(0, 0, 0, 0.3); border: 1px solid var(--accent-green);">
                                    <div class="card-header">
                                        <h6><i class="fas fa-lightbulb"></i> Password Tips</h6>
                                    </div>
                                    <div class="card-body">
                                        <ul id="suggestionsList" class="list-unstyled">
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`
    };
    
    return modals[moduleType] || '<div>Module not found</div>';
}

function confirmLegality() {
    return confirm('I confirm that I have permission to test this file and will use this tool responsibly and legally.');
}

function confirmEthicalUse() {
    return confirm('I confirm that I have permission to scan this website and will use this tool responsibly.');
}

function toggleWordlistUpload() {
    const select = document.getElementById('wordlistSelect');
    const customDiv = document.getElementById('customWordlistDiv');
    
    if (select.value === 'custom') {
        customDiv.style.display = 'block';
    } else {
        customDiv.style.display = 'none';
    }
}

let currentJobId = null;
let progressInterval = null;

function startBruteForce(event) {
    event.preventDefault();
    
    if (!confirmLegality()) {
        return false;
    }
    
    const form = document.getElementById('bruteForceForm');
    const formData = new FormData(form);
    
    // Hide form and show progress
    form.style.display = 'none';
    document.getElementById('bruteProgress').style.display = 'block';
    
    fetch('{{ url_for('start_brute') }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
            resetBruteForceForm();
        } else {
            currentJobId = data.job_id;
            startProgressMonitoring();
        }
    })
    .catch(error => {
        alert('Error: ' + error);
        resetBruteForceForm();
    });
    
    return false;
}

function startProgressMonitoring() {
    progressInterval = setInterval(() => {
        if (currentJobId) {
            fetch(`/api/job_status/${currentJobId}`)
            .then(response => response.json())
            .then(data => {
                updateProgress(data);
                
                if (data.status === 'completed' || data.status === 'failed' || data.status === 'cancelled') {
                    clearInterval(progressInterval);
                    setTimeout(() => {
                        resetBruteForceForm();
                        closeModal();
                    }, 3000);
                }
            });
        }
    }, 500); // Update every 500ms
}

function updateProgress(data) {
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const currentPassword = document.getElementById('currentPassword');
    const statusText = document.getElementById('statusText');
    
    progressBar.style.width = data.progress + '%';
    progressText.textContent = data.progress + '%';
    statusText.textContent = data.status.charAt(0).toUpperCase() + data.status.slice(1);
    
    if (data.result) {
        if (data.result.startsWith('Trying:')) {
            currentPassword.textContent = data.result.replace('Trying: ', '');
        } else if (data.result.startsWith('Password found:')) {
            currentPassword.textContent = 'SUCCESS!';
            statusText.innerHTML = '<span class="text-success">' + data.result + '</span>';
            progressBar.className = 'progress-bar bg-success';
        } else {
            currentPassword.textContent = '-';
            statusText.textContent = data.result;
            if (data.status === 'failed') {
                progressBar.className = 'progress-bar bg-danger';
            }
        }
    }
}

function cancelBruteForce() {
    if (currentJobId) {
        fetch(`/api/cancel_job/${currentJobId}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (progressInterval) {
                clearInterval(progressInterval);
            }
            resetBruteForceForm();
        });
    }
}

function resetBruteForceForm() {
    document.getElementById('bruteForceForm').style.display = 'block';
    document.getElementById('bruteProgress').style.display = 'none';
    
    // Reset progress
    document.getElementById('progressBar').style.width = '0%';
    document.getElementById('progressBar').className = 'progress-bar bg-warning';
    document.getElementById('progressText').textContent = '0%';
    document.getElementById('currentPassword').textContent = '-';
    document.getElementById('statusText').textContent = 'Running...';
    
    currentJobId = null;
    if (progressInterval) {
        clearInterval(progressInterval);
        progressInterval = null;
    }
}

function closeModal() {
    // Close the bootstrap modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('moduleModal'));
    if (modal) {
        modal.hide();
    }
}

function togglePasswordVisibility() {
    const passwordInput = document.getElementById('passwordInput');
    const toggleIcon = document.getElementById('toggleIcon');
    
    if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        toggleIcon.className = 'fas fa-eye-slash';
    } else {
        passwordInput.type = 'password';
        toggleIcon.className = 'fas fa-eye';
    }
}

function analyzePassword(event) {
    event.preventDefault();
    
    const form = document.getElementById('passwordAnalyzerForm');
    const formData = new FormData(form);
    const resultsDiv = document.getElementById('analysisResults');
    
    // Show loading state
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
    submitBtn.disabled = true;
    
    fetch('{{ url_for('analyze_password') }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            displayAnalysisResults(data.analysis, data.suggestions);
            resultsDiv.style.display = 'block';
        }
    })
    .catch(error => {
        alert('Error: ' + error);
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
    
    return false;
}

function displayAnalysisResults(analysis, suggestions) {
    // Update score and level
    document.getElementById('strengthScore').textContent = analysis.score;
    document.getElementById('strengthLevel').textContent = analysis.strength;
    
    // Update progress bar
    const strengthBar = document.getElementById('strengthBar');
    strengthBar.style.width = analysis.score + '%';
    
    // Set colors based on strength
    const colorClass = analysis.strength_color === 'success' ? 'bg-success' : 
                      analysis.strength_color === 'info' ? 'bg-info' :
                      analysis.strength_color === 'warning' ? 'bg-warning' : 'bg-danger';
    strengthBar.className = 'progress-bar ' + colorClass;
    
    // Update text colors
    const scoreElement = document.getElementById('strengthScore');
    const levelElement = document.getElementById('strengthLevel');
    scoreElement.className = 'text-' + analysis.strength_color;
    levelElement.className = 'text-' + analysis.strength_color;
    
    // Display details
    const detailsList = document.getElementById('detailsList');
    detailsList.innerHTML = '';
    
    const details = [
        { label: 'Length', value: analysis.details.length + ' characters', score: analysis.details.length_score },
        { label: 'Character Variety', value: analysis.details.character_variety.variety_count + '/4 types', score: analysis.details.variety_score },
        { label: 'Entropy', value: analysis.entropy + ' bits' },
        { label: 'Common Password', value: analysis.details.is_common_password ? 'Yes ⚠️' : 'No ✓' }
    ];
    
    details.forEach(detail => {
        const li = document.createElement('li');
        li.innerHTML = '<strong>' + detail.label + ':</strong> ' + detail.value;
        if (detail.score) {
            li.innerHTML += ' <small class="text-muted">(' + detail.score + ')</small>';
        }
        detailsList.appendChild(li);
    });
    
    // Display feedback
    const feedbackList = document.getElementById('feedbackList');
    feedbackList.innerHTML = '';
    analysis.feedback.forEach(feedback => {
        const li = document.createElement('li');
        li.innerHTML = '<i class="fas fa-arrow-right text-warning"></i> ' + feedback;
        feedbackList.appendChild(li);
    });
    
    // Display crack time
    document.getElementById('crackTime').textContent = analysis.estimated_crack_time;
    
    // Display suggestions
    const suggestionsList = document.getElementById('suggestionsList');
    suggestionsList.innerHTML = '';
    suggestions.forEach(suggestion => {
        const li = document.createElement('li');
        li.innerHTML = '<i class="fas fa-lightbulb text-success"></i> ' + suggestion;
        suggestionsList.appendChild(li);
    });
}
</script>
{% endblock %}
