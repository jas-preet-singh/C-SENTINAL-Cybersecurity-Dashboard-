{% extends "base.html" %}

{% block title %}Password Cracker - CyberSec Dashboard{% endblock %}

{% block content %}
<style>
/* Footer collision prevention - aggressive spacing */
.main-content {
    padding-bottom: 10rem !important;
}
.educational-section {
    margin-bottom: 4rem !important;
}
</style>

<div class="container-fluid">
 <div class="row">
 <div class="col-12">
 <div class="d-flex justify-content-between align-items-center mb-3">
 <h2><i class="fas fa-hammer"></i> Brute Force Simulator</h2>
 <a href="{{ url_for('index') }}" class="btn btn-outline-primary">
 <i class="fas fa-home"></i> Back to Home
 </a>
 </div>

 <div class="card module-card">
 <div class="card-body">
 <form id="bruteForceForm">
 <div class="row">
 <div class="col-md-6">
 <div class="mb-3">
 <label class="form-label">Select File to Crack</label>
 <input type="file" name="file" class="form-control" accept=".pdf,.zip,.docx" required>
 <small class="form-text text-muted">Supports PDF, ZIP, and DOCX files</small>
 </div>

 <div class="mb-3">
 <label class="form-label">Wordlist Type</label>
 <select name="wordlist" class="form-select" id="wordlistType">
 <option value="common">Common Passwords (10,000)</option>
 <option value="extended">Extended List (100,000)</option>
 <option value="custom">Upload Custom Wordlist</option>
 </select>
 </div>

 <div class="mb-3" id="customWordlistUpload" style="display: none;">
 <label class="form-label">Custom Wordlist File</label>
 <input type="file" name="wordlist_file" class="form-control" accept=".txt">
 <small class="form-text text-muted">One password per line</small>
 </div>

 <button type="submit" class="btn btn-warning btn-glow">
 <i class="fas fa-hammer"></i> Start Brute Force Attack
 </button>
 </div>

 <div class="col-md-6">
 <div class="info-card">
 <h5><i class="fas fa-exclamation-triangle"></i> Ethical Use Warning</h5>
 <div class="alert alert-warning">
 <strong>Educational Purposes Only!</strong>
 <ul class="mb-0 mt-2">
 <li>Only use on files you own</li>
 <li>Test password security awareness</li>
 <li>Demonstrate weak password risks</li>
 <li>Unauthorized use is illegal</li>
 </ul>
 </div>

 <h6 class="mt-3">How it works:</h6>
 <ol>
 <li>Attempts passwords from selected wordlist</li>
 <li>Shows real-time progress and attempts</li>
 <li>Reports success/failure with timing</li>
 <li>Demonstrates password vulnerability</li>
 </ol>
 </div>
 </div>
 </div>
 </form>

 <!-- Progress Section (Hidden initially) -->
 <div id="bruteProgress" style="display: none;" class="mt-3">
 <div class="card bg-dark">
 <div class="card-body">
 <h5>Brute Force Progress</h5>
 <div class="progress mb-3">
 <div id="progressBar" class="progress-bar bg-warning" style="width: 0%"></div>
 </div>
 <div class="row text-center">
 <div class="col-md-3">
 <strong>Progress:</strong><br>
 <span id="progressText">0%</span>
 </div>
 <div class="col-md-3">
 <strong>Status:</strong><br>
 <span id="statusText">Running...</span>
 </div>
 <div class="col-md-3">
 <strong>Current Password:</strong><br>
 <span id="currentPassword">-</span>
 </div>
 <div class="col-md-3">
 <button id="cancelBtn" class="btn btn-danger btn-sm">
 <i class="fas fa-stop"></i> Cancel
 </button>
 </div>
 </div>
 </div>
 </div>
 </div>
 </div>
 </div>
 </div>
 </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
 const wordlistType = document.getElementById('wordlistType');
 const customUpload = document.getElementById('customWordlistUpload');
 const bruteForceForm = document.getElementById('bruteForceForm');
 const progressSection = document.getElementById('bruteProgress');
 const cancelBtn = document.getElementById('cancelBtn');
 
 let currentJobId = null;
 let statusInterval = null;

 wordlistType.addEventListener('change', function() {
 customUpload.style.display = this.value === 'custom' ? 'block' : 'none';
 });
 
 // Handle form submission
 bruteForceForm.addEventListener('submit', function(e) {
 e.preventDefault();
 
 const formData = new FormData(this);
 const submitBtn = this.querySelector('button[type="submit"]');
 
 submitBtn.disabled = true;
 submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Starting...';
 
 fetch('/brute/start', {
 method: 'POST',
 body: formData
 })
 .then(response => response.json())
 .then(data => {
 if (data.error) {
 throw new Error(data.error);
 }
 
 currentJobId = data.job_id;
 progressSection.style.display = 'block';
 
 // Hide form and show progress
 bruteForceForm.style.display = 'none';
 
 // Start polling for status
 startStatusPolling();
 })
 .catch(error => {
 alert('Error starting brute force attack: ' + error.message);
 submitBtn.disabled = false;
 submitBtn.innerHTML = '<i class="fas fa-hammer"></i> Start Brute Force Attack';
 });
 });
 
 // Cancel job
 cancelBtn.addEventListener('click', function() {
 if (currentJobId) {
 fetch(`/api/cancel_job/${currentJobId}`, {
 method: 'POST'
 })
 .then(response => response.json())
 .then(data => {
 if (statusInterval) {
 clearInterval(statusInterval);
 }
 document.getElementById('statusText').textContent = 'Cancelled';
 setTimeout(() => {
 window.location.href = '/dashboard';
 }, 2000);
 });
 }
 });
 
 function startStatusPolling() {
 statusInterval = setInterval(() => {
 if (!currentJobId) return;
 
 fetch(`/api/job_status/${currentJobId}`)
 .then(response => response.json())
 .then(data => {
 // Update progress
 document.getElementById('progressBar').style.width = data.progress + '%';
 document.getElementById('progressText').textContent = data.progress + '%';
 document.getElementById('statusText').textContent = data.status.charAt(0).toUpperCase() + data.status.slice(1);
 
 // Check if job is complete
 if (data.status === 'completed' || data.status === 'failed' || data.status === 'cancelled') {
 clearInterval(statusInterval);
 
 // Show results and redirect
 if (data.status === 'completed') {
 document.getElementById('statusText').innerHTML = `
 <span class="text-success">
 <i class="fas fa-check-circle"></i> Completed!
 </span>`;
 
 if (data.result) {
 // Extract password using secure regex
 const passwordMatch = data.result.match(/^Password found:\s*/i);
 const extractedPassword = passwordMatch ? data.result.replace(/^Password found:\s*/i, '') : data.result;
 
 // Create secure DOM elements
 const currentPasswordDiv = document.getElementById('currentPassword');
 currentPasswordDiv.innerHTML = ''; // Clear existing content
 
 // Create success span
 const successSpan = document.createElement('span');
 successSpan.className = 'text-success';
 successSpan.textContent = 'Found: ';
 
 // Create password display (use textContent for security)
 const passwordStrong = document.createElement('strong');
 passwordStrong.textContent = extractedPassword;
 successSpan.appendChild(passwordStrong);
 
 // Create line break
 const lineBreak = document.createElement('br');
 
 // Create copy button securely
 const copyButton = document.createElement('button');
 copyButton.className = 'btn btn-outline-success btn-sm mt-1';
 copyButton.innerHTML = '<i class="fas fa-copy me-1"></i>Copy Password';
 
 // Add secure event listener
 copyButton.addEventListener('click', function() {
 copyPasswordToClipboard(this, extractedPassword);
 });
 
 // Append elements to DOM
 currentPasswordDiv.appendChild(successSpan);
 currentPasswordDiv.appendChild(lineBreak);
 currentPasswordDiv.appendChild(copyButton);
 }
 } else if (data.status === 'failed') {
 document.getElementById('statusText').innerHTML = `
 <span class="text-warning">
 <i class="fas fa-times-circle"></i> No password found
 </span>`;
 }
 
 // Redirect to dashboard after 15 seconds when password is found, 3 seconds otherwise
 const redirectDelay = data.status === 'completed' && data.result ? 15000 : 3000;
 setTimeout(() => {
 window.location.href = '/dashboard';
 }, redirectDelay);
 }
 })
 .catch(error => {
 console.error('Error checking job status:', error);
 });
 }, 2000);
 }
});

// Function to copy password to clipboard
function copyPasswordToClipboard(button, password) {
    navigator.clipboard.writeText(password).then(function() {
        // Show success feedback
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check me-1"></i>Copied!';
        button.classList.remove('btn-outline-success');
        button.classList.add('btn-success');
        
        // Reset button after 2 seconds
        setTimeout(function() {
            button.innerHTML = originalText;
            button.classList.remove('btn-success');
            button.classList.add('btn-outline-success');
        }, 2000);
    }).catch(function(err) {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = password;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        
        // Show success feedback
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check me-1"></i>Copied!';
        button.classList.remove('btn-outline-success');
        button.classList.add('btn-success');
        
        setTimeout(function() {
            button.innerHTML = originalText;
            button.classList.remove('btn-success');
            button.classList.add('btn-outline-success');
        }, 2000);
    });
}
</script>
{% endblock %}