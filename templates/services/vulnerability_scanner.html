{% extends "base.html" %}

{% block title %}Vulnerability Scanner - CyberSec Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
 <div class="row">
 <div class="col-12">
 <div class="d-flex justify-content-between align-items-center mb-3">
 <h2><i class="fas fa-bug"></i> Vulnerability Scanner</h2>
 <a href="{{ url_for('index') }}" class="btn btn-outline-primary">
 <i class="fas fa-home"></i> Back to Home
 </a>
 </div>

 <div class="row">
 <!-- Scanner Form -->
 <div class="col-md-8">
 <div class="card module-card">
 <div class="card-body">
 <form id="vulnerabilityScanForm" action="{{ url_for('vulnerability_scan_route') }}" method="post">
 <div class="mb-3">
 <label class="form-label">Target URL</label>
 <input type="url" name="url" id="vulnerabilityUrl" class="form-control" placeholder="https://example.com" required>
 <small class="form-text text-muted">Enter the website URL to scan for vulnerabilities</small>
 </div>

 <div class="mb-3">
 <div class="form-check">
 <input class="form-check-input" type="checkbox" id="ethicalUse" required>
 <label class="form-check-label" for="ethicalUse">
 I confirm that I have permission to scan this website and will use this tool ethically
 </label>
 </div>
 </div>

 <button type="submit" class="btn btn-danger btn-glow" id="scanVulnerabilityBtn">
 <i class="fas fa-search"></i> Start Vulnerability Scan
 </button>
 <div class="mt-2" id="vulnerabilitySpinner" style="display: none;">
 <div class="spinner-border spinner-border-sm text-danger me-2" role="status">
 <span class="visually-hidden">Scanning...</span>
 </div>
 Analyzing website for vulnerabilities...
 </div>
 </form>
 </div>
 </div>

 <!-- Results Section -->
 <div class="card module-card mt-3" id="vulnerabilityResults" style="display: none;">
 <div class="card-body">
 <h5 class="mb-3"><i class="fas fa-chart-line"></i> Vulnerability Assessment Results</h5>
 <div id="vulnerabilityResultsContent">
 <!-- Results will be populated here -->
 </div>
 </div>
 </div>

 <!-- Scan Types -->
 <div class="card module-card mt-3">
 <div class="card-body">
 <h5><i class="fas fa-list-check"></i> Vulnerability Checks Performed</h5>
 <div class="row">
 <div class="col-md-6">
 <ul>
 <li><i class="fas fa-database text-danger"></i> SQL Injection vulnerabilities</li>
 <li><i class="fas fa-code text-warning"></i> Cross-Site Scripting (XSS)</li>
 <li><i class="fas fa-server text-info"></i> Server information disclosure</li>
 <li><i class="fas fa-lock text-success"></i> SSL/TLS configuration</li>
 </ul>
 </div>
 <div class="col-md-6">
 <ul>
 <li><i class="fas fa-header text-primary"></i> Security headers analysis</li>
 <li><i class="fas fa-folder text-warning"></i> Directory traversal</li>
 <li><i class="fas fa-file text-info"></i> Sensitive file exposure</li>
 <li><i class="fas fa-shield-alt text-success"></i> Common misconfigurations</li>
 </ul>
 </div>
 </div>
 </div>
 </div>
 </div>

 <!-- Information Panel -->
 <div class="col-md-4">
 <div class="card module-card">
 <div class="card-body">
 <h5><i class="fas fa-info-circle"></i> About Vulnerability Scanning</h5>
 <p>This scanner performs basic security checks to identify common web vulnerabilities.</p>

 <h6 class="mt-3">Common Vulnerabilities:</h6>
 <ul class="small">
 <li><strong>SQL Injection:</strong> Database manipulation through input fields</li>
 <li><strong>XSS:</strong> Malicious script injection</li>
 <li><strong>CSRF:</strong> Cross-site request forgery</li>
 <li><strong>Security Misconfiguration:</strong> Improper server settings</li>
 </ul>

 <h6 class="mt-3">Scan Limitations:</h6>
 <ul class="small">
 <li>Basic pattern matching</li>
 <li>No deep application logic testing</li>
 <li>Limited to common vulnerabilities</li>
 <li>May produce false positives</li>
 </ul>
 </div>
 </div>

 <!-- Risk Levels -->
 <div class="card module-card mt-3">
 <div class="card-body">
 <h6><i class="fas fa-exclamation-triangle"></i> Risk Levels</h6>
 <div class="mb-2">
 <span class="badge bg-danger me-2">Critical</span>
 <small>Immediate action required</small>
 </div>
 <div class="mb-2">
 <span class="badge bg-warning me-2">High</span>
 <small>Address as soon as possible</small>
 </div>
 <div class="mb-2">
 <span class="badge bg-info me-2">Medium</span>
 <small>Should be addressed</small>
 </div>
 <div class="mb-2">
 <span class="badge bg-success me-2">Low</span>
 <small>Monitor and consider fixing</small>
 </div>
 </div>
 </div>
 </div>
 </div>

 <!-- Legal Notice -->
 <div class="alert alert-danger mt-3">
 <h6><i class="fas fa-gavel"></i> Legal and Ethical Notice</h6>
 <p class="mb-2"><strong>IMPORTANT:</strong> Only scan websites you own or have explicit written permission to test.</p>
 <ul class="mb-0">
 <li>Unauthorized vulnerability scanning may be illegal in your jurisdiction</li>
 <li>Always obtain proper authorization before testing</li>
 <li>Use this tool responsibly and ethically</li>
 <li>Report vulnerabilities through responsible disclosure practices</li>
 </ul>
 </div>
 </div>
 </div>
</div>

<script>
function confirmEthicalUse() {
 return confirm("I confirm that I own this website or have explicit written permission to perform security testing. Unauthorized scanning may be illegal.");
}

// HTML escape function to prevent XSS
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Safe createElement helper
function createElementSafe(tag, className = '', textContent = '') {
    const el = document.createElement(tag);
    if (className) el.className = className;
    if (textContent) el.textContent = textContent;
    return el;
}

// AJAX form submission for vulnerability scanner
document.getElementById('vulnerabilityScanForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (!confirmEthicalUse()) {
        return false;
    }
    
    const form = e.target;
    const formData = new FormData(form);
    const url = document.getElementById('vulnerabilityUrl').value;
    
    // Show loading state
    document.getElementById('scanVulnerabilityBtn').disabled = true;
    document.getElementById('vulnerabilitySpinner').style.display = 'block';
    document.getElementById('vulnerabilityResults').style.display = 'none';
    
    fetch(form.action, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        // Check if user needs to authenticate (redirect to login)
        if (response.redirected && response.url.includes('/auth/')) {
            window.location.href = response.url;
            return;
        }
        
        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Server response was not JSON. Please refresh the page and try again.');
        }
        
        // Check for HTTP errors
        if (!response.ok) {
            throw new Error(`Server error: ${response.status} ${response.statusText}`);
        }
        
        return response.json();
    })
    .then(data => {
        // Skip if redirected to auth
        if (!data) return;
        
        // Hide loading state
        document.getElementById('scanVulnerabilityBtn').disabled = false;
        document.getElementById('vulnerabilitySpinner').style.display = 'none';
        
        // Display results
        displayVulnerabilityResults(data, url);
        document.getElementById('vulnerabilityResults').style.display = 'block';
    })
    .catch(error => {
        // Hide loading state
        document.getElementById('scanVulnerabilityBtn').disabled = false;
        document.getElementById('vulnerabilitySpinner').style.display = 'none';
        
        // Show error safely - no XSS vulnerability
        const container = document.getElementById('vulnerabilityResultsContent');
        container.innerHTML = ''; // Clear previous content
        
        const errorDiv = createElementSafe('div', 'alert alert-danger');
        const errorIcon = document.createElement('i');
        errorIcon.className = 'fas fa-exclamation-triangle';
        
        const errorStrong = createElementSafe('strong', '', 'Error: ');
        const errorText = document.createTextNode(error.message || 'An error occurred while scanning the URL.');
        
        errorDiv.appendChild(errorIcon);
        errorDiv.appendChild(document.createTextNode(' '));
        errorDiv.appendChild(errorStrong);
        errorDiv.appendChild(errorText);
        
        container.appendChild(errorDiv);
        document.getElementById('vulnerabilityResults').style.display = 'block';
    });
});

function displayVulnerabilityResults(data, url) {
    const container = document.getElementById('vulnerabilityResultsContent');
    container.innerHTML = ''; // Clear previous content
    
    if (!data.success) {
        const errorDiv = createElementSafe('div', 'alert alert-danger');
        const errorIcon = document.createElement('i');
        errorIcon.className = 'fas fa-exclamation-triangle';
        
        const errorStrong = createElementSafe('strong', '', 'Error: ');
        const errorText = document.createTextNode(data.error || 'An error occurred');
        
        errorDiv.appendChild(errorIcon);
        errorDiv.appendChild(document.createTextNode(' '));
        errorDiv.appendChild(errorStrong);
        errorDiv.appendChild(errorText);
        
        container.appendChild(errorDiv);
        return;
    }
    
    // Determine status and styling based on risk level
    let statusClass, statusIcon, statusText;
    const riskLevel = (data.risk_level || '').toLowerCase();
    switch(riskLevel) {
        case 'high':
            statusClass = 'danger';
            statusIcon = 'fas fa-times-circle';
            statusText = 'HIGH RISK - IMMEDIATE ATTENTION REQUIRED';
            break;
        case 'medium':
            statusClass = 'warning';
            statusIcon = 'fas fa-exclamation-triangle';
            statusText = 'MEDIUM RISK - SHOULD BE ADDRESSED';
            break;
        case 'low':
            statusClass = 'success';
            statusIcon = 'fas fa-check-circle';
            statusText = 'LOW RISK - NO IMMEDIATE THREATS DETECTED';
            break;
        default:
            statusClass = 'secondary';
            statusIcon = 'fas fa-question-circle';
            statusText = 'UNKNOWN RISK - SCAN INCOMPLETE';
    }
    
    // Create compact single-column layout
    const mainDiv = createElementSafe('div', 'col-12');
    
    // Status alert - more compact
    const alertDiv = createElementSafe('div', `alert alert-${statusClass} mb-2`);
    
    const alertHeader = createElementSafe('div', 'd-flex align-items-center justify-content-between mb-1');
    
    const alertLeft = createElementSafe('div', 'd-flex align-items-center');
    const alertIcon = document.createElement('i');
    alertIcon.className = `${statusIcon} me-2`;
    const alertStrong = createElementSafe('strong', '', `${statusText}`);
    alertLeft.appendChild(alertIcon);
    alertLeft.appendChild(alertStrong);
    
    const alertRight = createElementSafe('div', 'text-end');
    const urlSpan = createElementSafe('small', 'text-muted');
    urlSpan.appendChild(document.createTextNode(`${url || 'Unknown'}`));
    alertRight.appendChild(urlSpan);
    
    alertHeader.appendChild(alertLeft);
    alertHeader.appendChild(alertRight);
    alertDiv.appendChild(alertHeader);
    
    // Risk info in compact format
    const riskInfo = createElementSafe('div', 'd-flex justify-content-between small');
    const riskLeft = createElementSafe('span');
    riskLeft.appendChild(document.createTextNode(`Risk Level: ${(data.risk_level || 'Unknown').toUpperCase()}`));
    const riskRight = createElementSafe('span');
    riskRight.appendChild(document.createTextNode(`Vulnerabilities: ${data.vulnerability_count || 0}`));
    riskInfo.appendChild(riskLeft);
    riskInfo.appendChild(riskRight);
    alertDiv.appendChild(riskInfo);
    
    mainDiv.appendChild(alertDiv);
    
    // Create compact results section
    const resultsDiv = createElementSafe('div', 'row');
    
    // Left side - Vulnerabilities
    const leftCol = createElementSafe('div', 'col-md-6');
    
    // Build vulnerabilities list safely - more compact
    if (data.vulnerabilities && data.vulnerabilities.length > 0) {
        const vulnCard = createElementSafe('div', 'card border-danger mb-2');
        const vulnHeader = createElementSafe('div', 'card-header bg-danger text-white py-1');
        vulnHeader.appendChild(document.createTextNode('ðŸš¨ Vulnerabilities Found'));
        vulnCard.appendChild(vulnHeader);
        
        const vulnBody = createElementSafe('div', 'card-body py-2');
        const vulnList = createElementSafe('ul', 'mb-0 small');
        data.vulnerabilities.forEach(vuln => {
            const listItem = createElementSafe('li', 'mb-1');
            listItem.appendChild(document.createTextNode(String(vuln)));
            vulnList.appendChild(listItem);
        });
        vulnBody.appendChild(vulnList);
        vulnCard.appendChild(vulnBody);
        leftCol.appendChild(vulnCard);
    } else {
        const safeCard = createElementSafe('div', 'card border-success mb-2');
        const safeHeader = createElementSafe('div', 'card-header bg-success text-white py-1');
        safeHeader.appendChild(document.createTextNode('âœ… Security Status'));
        safeCard.appendChild(safeHeader);
        
        const safeBody = createElementSafe('div', 'card-body py-2');
        const safeText = createElementSafe('p', 'mb-0 small text-success');
        safeText.appendChild(document.createTextNode('No obvious vulnerabilities detected in basic scan.'));
        safeBody.appendChild(safeText);
        safeCard.appendChild(safeBody);
        leftCol.appendChild(safeCard);
    }
    
    // Right side - Analysis Details
    const rightCol = createElementSafe('div', 'col-md-6');
    
    // Compact security analysis sections
    
    // Combined Issues & Strengths in one compact card
    const analysisCard = createElementSafe('div', 'card mb-2');
    const analysisHeader = createElementSafe('div', 'card-header py-1');
    analysisHeader.appendChild(document.createTextNode('ðŸ“‹ Security Analysis'));
    analysisCard.appendChild(analysisHeader);
    
    const analysisBody = createElementSafe('div', 'card-body py-2');
    
    // Security Issues
    if (data.security_issues && data.security_issues.length > 0) {
        const issuesDiv = createElementSafe('div', 'mb-2');
        const issuesTitle = createElementSafe('small', 'fw-bold text-danger d-block mb-1');
        issuesTitle.appendChild(document.createTextNode('âš ï¸ Security Issues:'));
        issuesDiv.appendChild(issuesTitle);
        
        const issuesList = createElementSafe('ul', 'small mb-2 text-danger');
        data.security_issues.forEach(issue => {
            const listItem = createElementSafe('li', 'mb-1');
            listItem.appendChild(document.createTextNode(String(issue)));
            issuesList.appendChild(listItem);
        });
        issuesDiv.appendChild(issuesList);
        analysisBody.appendChild(issuesDiv);
    }
    
    // Security Strengths
    if (data.security_strengths && data.security_strengths.length > 0) {
        const strengthsDiv = createElementSafe('div', 'mb-2');
        const strengthsTitle = createElementSafe('small', 'fw-bold text-success d-block mb-1');
        strengthsTitle.appendChild(document.createTextNode('âœ… Security Strengths:'));
        strengthsDiv.appendChild(strengthsTitle);
        
        const strengthsList = createElementSafe('ul', 'small mb-0 text-success');
        data.security_strengths.forEach(strength => {
            const listItem = createElementSafe('li', 'mb-1');
            listItem.appendChild(document.createTextNode(String(strength)));
            strengthsList.appendChild(listItem);
        });
        strengthsDiv.appendChild(strengthsList);
        analysisBody.appendChild(strengthsDiv);
    }
    
    // If no specific issues or strengths, show general analysis
    if ((!data.security_issues || data.security_issues.length === 0) && 
        (!data.security_strengths || data.security_strengths.length === 0)) {
        const generalAnalysis = createElementSafe('p', 'small text-muted mb-0');
        generalAnalysis.appendChild(document.createTextNode('Basic security scan completed. See detailed assessment above.'));
        analysisBody.appendChild(generalAnalysis);
    }
    
    analysisCard.appendChild(analysisBody);
    rightCol.appendChild(analysisCard);
    
    // Compact Security Headers section
    if ((data.missing_headers && data.missing_headers.length > 0) || 
        (data.present_headers && data.present_headers.length > 0)) {
        
        const headersCard = createElementSafe('div', 'card border-info mb-2');
        const headersHeader = createElementSafe('div', 'card-header bg-light py-1');
        headersHeader.appendChild(document.createTextNode('ðŸ”’ Security Headers'));
        headersCard.appendChild(headersHeader);
        
        const headersBody = createElementSafe('div', 'card-body py-2');
        
        // Missing headers
        if (data.missing_headers && data.missing_headers.length > 0) {
            const missingDiv = createElementSafe('div', 'mb-2');
            const missingTitle = createElementSafe('small', 'fw-bold text-warning d-block mb-1');
            missingTitle.appendChild(document.createTextNode('âš ï¸ Missing Headers:'));
            missingDiv.appendChild(missingTitle);
            
            const missingList = createElementSafe('ul', 'small mb-2 text-warning');
            data.missing_headers.forEach(header => {
                const listItem = createElementSafe('li', 'mb-1');
                listItem.appendChild(document.createTextNode(String(header)));
                missingList.appendChild(listItem);
            });
            missingDiv.appendChild(missingList);
            headersBody.appendChild(missingDiv);
        }
        
        // Present headers
        if (data.present_headers && data.present_headers.length > 0) {
            const presentDiv = createElementSafe('div');
            const presentTitle = createElementSafe('small', 'fw-bold text-info d-block mb-1');
            presentTitle.appendChild(document.createTextNode('âœ“ Present Headers:'));
            presentDiv.appendChild(presentTitle);
            
            const presentList = createElementSafe('ul', 'small mb-0 text-info');
            data.present_headers.forEach(header => {
                const listItem = createElementSafe('li', 'mb-1');
                listItem.appendChild(document.createTextNode(String(header)));
                presentList.appendChild(listItem);
            });
            presentDiv.appendChild(presentList);
            headersBody.appendChild(presentDiv);
        }
        
        headersCard.appendChild(headersBody);
        rightCol.appendChild(headersCard);
    }
    
    // Assemble the compact layout
    resultsDiv.appendChild(leftCol);
    resultsDiv.appendChild(rightCol);
    mainDiv.appendChild(resultsDiv);
    container.appendChild(mainDiv);
}
</script>
{% endblock %}