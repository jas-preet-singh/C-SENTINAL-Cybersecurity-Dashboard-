{% extends "base.html" %}

{% block title %}Vulnerability Scanner - CyberSec Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
 <div class="row">
 <div class="col-12">
 <div class="d-flex justify-content-between align-items-center mb-3">
 <h2><i class="fas fa-bug"></i> Vulnerability Scanner</h2>
 <a href="{{ url_for('index') }}" class="btn btn-outline-primary">
 <i class="fas fa-home"></i> Back to Home
 </a>
 </div>

 <div class="row">
 <!-- Scanner Form -->
 <div class="col-md-8">
 <div class="card module-card">
 <div class="card-body">
 <form id="vulnerabilityScanForm" action="{{ url_for('vulnerability_scan_route') }}" method="post">
 <div class="mb-3">
 <label class="form-label">Target URL</label>
 <input type="url" name="url" id="vulnerabilityUrl" class="form-control" placeholder="https://example.com" required>
 <small class="form-text text-muted">Enter the website URL to scan for vulnerabilities</small>
 </div>

 <div class="mb-3">
 <div class="form-check">
 <input class="form-check-input" type="checkbox" id="ethicalUse" required>
 <label class="form-check-label" for="ethicalUse">
 I confirm that I have permission to scan this website and will use this tool ethically
 </label>
 </div>
 </div>

 <button type="submit" class="btn btn-danger btn-glow" id="scanVulnerabilityBtn">
 <i class="fas fa-search"></i> Start Vulnerability Scan
 </button>
 <div class="mt-2" id="vulnerabilitySpinner" style="display: none;">
 <div class="spinner-border spinner-border-sm text-danger me-2" role="status">
 <span class="visually-hidden">Scanning...</span>
 </div>
 Analyzing website for vulnerabilities...
 </div>
 </form>
 </div>
 </div>

 <!-- Results Section -->
 <div class="card module-card mt-3" id="vulnerabilityResults" style="display: none;">
 <div class="card-body">
 <h5 class="mb-3"><i class="fas fa-chart-line"></i> Vulnerability Assessment Results</h5>
 <div id="vulnerabilityResultsContent">
 <!-- Results will be populated here -->
 </div>
 </div>
 </div>

 <!-- Scan Types -->
 <div class="card module-card mt-3">
 <div class="card-body">
 <h5><i class="fas fa-list-check"></i> Vulnerability Checks Performed</h5>
 <div class="row">
 <div class="col-md-6">
 <ul>
 <li><i class="fas fa-database text-danger"></i> SQL Injection vulnerabilities</li>
 <li><i class="fas fa-code text-warning"></i> Cross-Site Scripting (XSS)</li>
 <li><i class="fas fa-server text-info"></i> Server information disclosure</li>
 <li><i class="fas fa-lock text-success"></i> SSL/TLS configuration</li>
 </ul>
 </div>
 <div class="col-md-6">
 <ul>
 <li><i class="fas fa-header text-primary"></i> Security headers analysis</li>
 <li><i class="fas fa-folder text-warning"></i> Directory traversal</li>
 <li><i class="fas fa-file text-info"></i> Sensitive file exposure</li>
 <li><i class="fas fa-shield-alt text-success"></i> Common misconfigurations</li>
 </ul>
 </div>
 </div>
 </div>
 </div>
 </div>

 <!-- Information Panel -->
 <div class="col-md-4">
 <div class="card module-card">
 <div class="card-body">
 <h5><i class="fas fa-info-circle"></i> About Vulnerability Scanning</h5>
 <p>This scanner performs basic security checks to identify common web vulnerabilities.</p>

 <h6 class="mt-3">Common Vulnerabilities:</h6>
 <ul class="small">
 <li><strong>SQL Injection:</strong> Database manipulation through input fields</li>
 <li><strong>XSS:</strong> Malicious script injection</li>
 <li><strong>CSRF:</strong> Cross-site request forgery</li>
 <li><strong>Security Misconfiguration:</strong> Improper server settings</li>
 </ul>

 <h6 class="mt-3">Scan Limitations:</h6>
 <ul class="small">
 <li>Basic pattern matching</li>
 <li>No deep application logic testing</li>
 <li>Limited to common vulnerabilities</li>
 <li>May produce false positives</li>
 </ul>
 </div>
 </div>

 <!-- Risk Levels -->
 <div class="card module-card mt-3">
 <div class="card-body">
 <h6><i class="fas fa-exclamation-triangle"></i> Risk Levels</h6>
 <div class="mb-2">
 <span class="badge bg-danger me-2">Critical</span>
 <small>Immediate action required</small>
 </div>
 <div class="mb-2">
 <span class="badge bg-warning me-2">High</span>
 <small>Address as soon as possible</small>
 </div>
 <div class="mb-2">
 <span class="badge bg-info me-2">Medium</span>
 <small>Should be addressed</small>
 </div>
 <div class="mb-2">
 <span class="badge bg-success me-2">Low</span>
 <small>Monitor and consider fixing</small>
 </div>
 </div>
 </div>
 </div>
 </div>

 <!-- Legal Notice -->
 <div class="alert alert-danger mt-3">
 <h6><i class="fas fa-gavel"></i> Legal and Ethical Notice</h6>
 <p class="mb-2"><strong>IMPORTANT:</strong> Only scan websites you own or have explicit written permission to test.</p>
 <ul class="mb-0">
 <li>Unauthorized vulnerability scanning may be illegal in your jurisdiction</li>
 <li>Always obtain proper authorization before testing</li>
 <li>Use this tool responsibly and ethically</li>
 <li>Report vulnerabilities through responsible disclosure practices</li>
 </ul>
 </div>
 </div>
 </div>
</div>

<script>
function confirmEthicalUse() {
 return confirm("I confirm that I own this website or have explicit written permission to perform security testing. Unauthorized scanning may be illegal.");
}

// HTML escape function to prevent XSS
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Safe createElement helper
function createElementSafe(tag, className = '', textContent = '') {
    const el = document.createElement(tag);
    if (className) el.className = className;
    if (textContent) el.textContent = textContent;
    return el;
}

// AJAX form submission for vulnerability scanner
document.getElementById('vulnerabilityScanForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (!confirmEthicalUse()) {
        return false;
    }
    
    const form = e.target;
    const formData = new FormData(form);
    const url = document.getElementById('vulnerabilityUrl').value;
    
    // Show loading state
    document.getElementById('scanVulnerabilityBtn').disabled = true;
    document.getElementById('vulnerabilitySpinner').style.display = 'block';
    document.getElementById('vulnerabilityResults').style.display = 'none';
    
    fetch(form.action, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        // Check if user needs to authenticate (redirect to login)
        if (response.redirected && response.url.includes('/auth/')) {
            window.location.href = response.url;
            return;
        }
        
        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Server response was not JSON. Please refresh the page and try again.');
        }
        
        // Check for HTTP errors
        if (!response.ok) {
            throw new Error(`Server error: ${response.status} ${response.statusText}`);
        }
        
        return response.json();
    })
    .then(data => {
        // Skip if redirected to auth
        if (!data) return;
        
        // Hide loading state
        document.getElementById('scanVulnerabilityBtn').disabled = false;
        document.getElementById('vulnerabilitySpinner').style.display = 'none';
        
        // Display results
        displayVulnerabilityResults(data, url);
        document.getElementById('vulnerabilityResults').style.display = 'block';
    })
    .catch(error => {
        // Hide loading state
        document.getElementById('scanVulnerabilityBtn').disabled = false;
        document.getElementById('vulnerabilitySpinner').style.display = 'none';
        
        // Show error safely - no XSS vulnerability
        const container = document.getElementById('vulnerabilityResultsContent');
        container.innerHTML = ''; // Clear previous content
        
        const errorDiv = createElementSafe('div', 'alert alert-danger');
        const errorIcon = document.createElement('i');
        errorIcon.className = 'fas fa-exclamation-triangle';
        
        const errorStrong = createElementSafe('strong', '', 'Error: ');
        const errorText = document.createTextNode(error.message || 'An error occurred while scanning the URL.');
        
        errorDiv.appendChild(errorIcon);
        errorDiv.appendChild(document.createTextNode(' '));
        errorDiv.appendChild(errorStrong);
        errorDiv.appendChild(errorText);
        
        container.appendChild(errorDiv);
        document.getElementById('vulnerabilityResults').style.display = 'block';
    });
});

function displayVulnerabilityResults(data, url) {
    const container = document.getElementById('vulnerabilityResultsContent');
    container.innerHTML = ''; // Clear previous content
    
    if (!data.success) {
        const errorDiv = createElementSafe('div', 'alert alert-danger');
        const errorIcon = document.createElement('i');
        errorIcon.className = 'fas fa-exclamation-triangle';
        
        const errorStrong = createElementSafe('strong', '', 'Error: ');
        const errorText = document.createTextNode(data.error || 'An error occurred');
        
        errorDiv.appendChild(errorIcon);
        errorDiv.appendChild(document.createTextNode(' '));
        errorDiv.appendChild(errorStrong);
        errorDiv.appendChild(errorText);
        
        container.appendChild(errorDiv);
        return;
    }
    
    // Determine status and styling based on risk level
    let statusClass, statusIcon, statusText;
    const riskLevel = (data.risk_level || '').toLowerCase();
    switch(riskLevel) {
        case 'high':
            statusClass = 'danger';
            statusIcon = 'fas fa-times-circle';
            statusText = 'HIGH RISK - IMMEDIATE ATTENTION REQUIRED';
            break;
        case 'medium':
            statusClass = 'warning';
            statusIcon = 'fas fa-exclamation-triangle';
            statusText = 'MEDIUM RISK - SHOULD BE ADDRESSED';
            break;
        case 'low':
            statusClass = 'success';
            statusIcon = 'fas fa-check-circle';
            statusText = 'LOW RISK - NO IMMEDIATE THREATS DETECTED';
            break;
        default:
            statusClass = 'secondary';
            statusIcon = 'fas fa-question-circle';
            statusText = 'UNKNOWN RISK - SCAN INCOMPLETE';
    }
    
    // Create main row container
    const rowDiv = createElementSafe('div', 'row');
    
    // Left column
    const leftCol = createElementSafe('div', 'col-md-6');
    
    // Status alert
    const alertDiv = createElementSafe('div', `alert alert-${statusClass} mb-3`);
    
    const alertHeader = createElementSafe('div', 'd-flex align-items-center mb-2');
    const alertIcon = document.createElement('i');
    alertIcon.className = `${statusIcon} me-2`;
    const alertStrong = createElementSafe('strong', '', `Assessment: ${statusText}`);
    
    alertHeader.appendChild(alertIcon);
    alertHeader.appendChild(alertStrong);
    alertDiv.appendChild(alertHeader);
    
    // URL info
    const urlSmall = createElementSafe('small');
    const urlStrong = createElementSafe('strong', '', 'URL: ');
    urlSmall.appendChild(urlStrong);
    urlSmall.appendChild(document.createTextNode(url || 'Unknown'));
    urlSmall.appendChild(document.createElement('br'));
    
    // Risk level info
    const riskStrong = createElementSafe('strong', '', 'Risk Level: ');
    urlSmall.appendChild(riskStrong);
    urlSmall.appendChild(document.createTextNode((data.risk_level || 'Unknown').toUpperCase()));
    urlSmall.appendChild(document.createElement('br'));
    
    // Vulnerability count info
    const countStrong = createElementSafe('strong', '', 'Vulnerabilities Count: ');
    urlSmall.appendChild(countStrong);
    urlSmall.appendChild(document.createTextNode(String(data.vulnerability_count || 0)));
    
    alertDiv.appendChild(urlSmall);
    leftCol.appendChild(alertDiv);
    
    // Build vulnerabilities list safely
    if (data.vulnerabilities && data.vulnerabilities.length > 0) {
        const vulnHeader = createElementSafe('h6', 'mt-3', 'Vulnerabilities Found:');
        leftCol.appendChild(vulnHeader);
        
        const vulnList = createElementSafe('ul');
        data.vulnerabilities.forEach(vuln => {
            const listItem = createElementSafe('li');
            const strong = createElementSafe('strong', '', String(vuln));
            listItem.appendChild(strong);
            vulnList.appendChild(listItem);
        });
        leftCol.appendChild(vulnList);
    } else {
        const vulnHeader = createElementSafe('h6', 'mt-3', 'Vulnerabilities Found:');
        leftCol.appendChild(vulnHeader);
        
        const noVulnText = createElementSafe('p', 'text-success', 'No obvious vulnerabilities detected.');
        leftCol.appendChild(noVulnText);
    }
    
    // Right column
    const rightCol = createElementSafe('div', 'col-md-6');
    
    // Build comprehensive security analysis sections
    
    // Security Issues section (detailed problems)
    if (data.security_issues && data.security_issues.length > 0) {
        const issuesHeader = createElementSafe('h6', 'text-danger mt-3');
        issuesHeader.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Security Issues Detected:';
        rightCol.appendChild(issuesHeader);
        
        const issuesList = createElementSafe('ul', 'list-group list-group-flush mb-3');
        data.security_issues.forEach(issue => {
            const listItem = createElementSafe('li', 'list-group-item list-group-item-danger');
            listItem.innerHTML = '<i class="fas fa-times me-2"></i>' + escapeHtml(String(issue));
            issuesList.appendChild(listItem);
        });
        rightCol.appendChild(issuesList);
    }
    
    // Security Strengths section (positive features)
    if (data.security_strengths && data.security_strengths.length > 0) {
        const strengthsHeader = createElementSafe('h6', 'text-success mt-3');
        strengthsHeader.innerHTML = '<i class="fas fa-shield-alt me-2"></i>Security Strengths Found:';
        rightCol.appendChild(strengthsHeader);
        
        const strengthsList = createElementSafe('ul', 'list-group list-group-flush mb-3');
        data.security_strengths.forEach(strength => {
            const listItem = createElementSafe('li', 'list-group-item list-group-item-success');
            listItem.innerHTML = '<i class="fas fa-check me-2"></i>' + escapeHtml(String(strength));
            strengthsList.appendChild(listItem);
        });
        rightCol.appendChild(strengthsList);
    }
    
    // Security Headers Analysis section
    if ((data.missing_headers && data.missing_headers.length > 0) || (data.present_headers && data.present_headers.length > 0)) {
        const headersHeader = createElementSafe('h6', 'text-primary mt-3');
        headersHeader.innerHTML = '<i class="fas fa-header me-2"></i>Security Headers Analysis:';
        rightCol.appendChild(headersHeader);
        
        // Missing headers (security concerns)
        if (data.missing_headers && data.missing_headers.length > 0) {
            const missingSubHeader = createElementSafe('small', 'text-muted d-block mb-2', 'Missing Security Headers:');
            rightCol.appendChild(missingSubHeader);
            
            const missingList = createElementSafe('ul', 'list-group list-group-flush mb-2');
            data.missing_headers.forEach(header => {
                const listItem = createElementSafe('li', 'list-group-item list-group-item-warning');
                listItem.innerHTML = '<i class="fas fa-minus-circle me-2"></i>' + escapeHtml(String(header));
                missingList.appendChild(listItem);
            });
            rightCol.appendChild(missingList);
        }
        
        // Present headers (security strengths)
        if (data.present_headers && data.present_headers.length > 0) {
            const presentSubHeader = createElementSafe('small', 'text-muted d-block mb-2', 'Present Security Headers:');
            rightCol.appendChild(presentSubHeader);
            
            const presentList = createElementSafe('ul', 'list-group list-group-flush mb-3');
            data.present_headers.forEach(header => {
                const listItem = createElementSafe('li', 'list-group-item list-group-item-info');
                listItem.innerHTML = '<i class="fas fa-plus-circle me-2"></i>' + escapeHtml(String(header));
                presentList.appendChild(listItem);
            });
            rightCol.appendChild(presentList);
        }
    }
    
    // General assessment details (fallback for additional reasons)
    if (data.reasons && data.reasons.length > 0) {
        const reasonsHeader = createElementSafe('h6', 'text-info mt-3');
        reasonsHeader.innerHTML = '<i class="fas fa-info-circle me-2"></i>Additional Assessment Notes:';
        rightCol.appendChild(reasonsHeader);
        
        const reasonsList = createElementSafe('ul', 'list-group list-group-flush');
        data.reasons.forEach(reason => {
            const listItem = createElementSafe('li', 'list-group-item');
            listItem.innerHTML = '<i class="fas fa-arrow-right me-2"></i>' + escapeHtml(String(reason));
            reasonsList.appendChild(listItem);
        });
        rightCol.appendChild(reasonsList);
    }
    
    // Assemble the final structure
    rowDiv.appendChild(leftCol);
    rowDiv.appendChild(rightCol);
    container.appendChild(rowDiv);
    
    // Add summary card at the bottom
    const summaryCard = createElementSafe('div', 'card border-info mt-4');
    const summaryBody = createElementSafe('div', 'card-body');
    const summaryTitle = createElementSafe('h6', 'card-title text-info');
    summaryTitle.innerHTML = '<i class="fas fa-chart-pie me-2"></i>Security Assessment Summary';
    summaryBody.appendChild(summaryTitle);
    
    const summaryText = createElementSafe('p', 'card-text');
    const vulnCount = data.vulnerability_count || 0;
    const issueCount = (data.security_issues && data.security_issues.length) || 0;
    const strengthCount = (data.security_strengths && data.security_strengths.length) || 0;
    
    summaryText.textContent = `This scan identified ${vulnCount} potential vulnerabilities, ` +
        `${issueCount} security issues, and ${strengthCount} security strengths. ` +
        `Review the detailed analysis above for specific recommendations and explanations.`;
    summaryBody.appendChild(summaryText);
    
    if (data.risk_level === 'high') {
        const warningText = createElementSafe('div', 'alert alert-warning mt-2');
        warningText.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>' +
            '<strong>Recommendation:</strong> Address critical vulnerabilities immediately and consider ' +
            'professional security assessment for comprehensive analysis.';
        summaryBody.appendChild(warningText);
    }
    
    summaryCard.appendChild(summaryBody);
    container.appendChild(summaryCard);
}
</script>
{% endblock %}