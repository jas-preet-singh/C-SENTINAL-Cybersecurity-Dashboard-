{% extends "base.html" %}

{% block title %}Vulnerability Scanner - CyberSec Dashboard{% endblock %}

{% block content %}
<style>
/* Footer collision prevention - aggressive spacing */
.main-content {
    padding-bottom: 10rem !important;
}
.educational-section {
    margin-bottom: 4rem !important;
}
</style>

<div class="container-fluid">
 <div class="row">
 <div class="col-12">
 <div class="d-flex justify-content-between align-items-center mb-3">
 <h2><i class="fas fa-bug"></i> Vulnerability Scanner</h2>
 <a href="{{ url_for('index') }}" class="btn btn-outline-primary">
 <i class="fas fa-home"></i> Back to Home
 </a>
 </div>

 <div class="row">
 <!-- Scanner Form -->
 <div class="col-md-8">
 <div class="card module-card">
 <div class="card-body">
 <form id="vulnerabilityScanForm" action="{{ url_for('vulnerability_scan_route') }}" method="post">
 <div class="mb-3">
 <label class="form-label">Target URL</label>
 <input type="url" name="url" id="vulnerabilityUrl" class="form-control" placeholder="https://example.com" required>
 <small class="form-text text-muted">Enter the website URL to scan for vulnerabilities</small>
 </div>

 <div class="mb-3">
 <div class="form-check">
 <input class="form-check-input" type="checkbox" id="ethicalUse" required>
 <label class="form-check-label" for="ethicalUse">
 I confirm that I have permission to scan this website and will use this tool ethically
 </label>
 </div>
 </div>

 <button type="submit" class="btn btn-danger btn-glow" id="scanVulnerabilityBtn">
 <i class="fas fa-search"></i> Start Vulnerability Scan
 </button>
 <div class="mt-2" id="vulnerabilitySpinner" style="display: none;">
 <div class="spinner-border spinner-border-sm text-danger me-2" role="status">
 <span class="visually-hidden">Scanning...</span>
 </div>
 Analyzing website for vulnerabilities...
 </div>
 </form>
 </div>
 </div>

 <!-- Results Section -->
 <div id="vulnerabilityResults" style="display: none;" class="mt-3">
 <div id="vulnerabilityResultsContent">
 <!-- Results will be populated here -->
 </div>
 </div>

 <!-- Scan Types -->
 <div class="card module-card mt-3">
 <div class="card-body">
 <h5><i class="fas fa-list-check"></i> Vulnerability Checks Performed</h5>
 <div class="row">
 <div class="col-md-6">
 <ul>
 <li><i class="fas fa-database text-danger"></i> SQL Injection vulnerabilities</li>
 <li><i class="fas fa-code text-warning"></i> Cross-Site Scripting (XSS)</li>
 <li><i class="fas fa-server text-info"></i> Server information disclosure</li>
 <li><i class="fas fa-lock text-success"></i> SSL/TLS configuration</li>
 </ul>
 </div>
 <div class="col-md-6">
 <ul>
 <li><i class="fas fa-header text-primary"></i> Security headers analysis</li>
 <li><i class="fas fa-folder text-warning"></i> Directory traversal</li>
 <li><i class="fas fa-file text-info"></i> Sensitive file exposure</li>
 <li><i class="fas fa-shield-alt text-success"></i> Common misconfigurations</li>
 </ul>
 </div>
 </div>
 </div>
 </div>
 </div>

 <!-- Information Panel -->
 <div class="col-md-4">
 <div class="card module-card">
 <div class="card-body">
 <h5><i class="fas fa-info-circle"></i> About Vulnerability Scanning</h5>
 <p>This scanner performs basic security checks to identify common web vulnerabilities.</p>

 <h6 class="mt-3">Common Vulnerabilities:</h6>
 <ul class="small">
 <li><strong>SQL Injection:</strong> Database manipulation through input fields</li>
 <li><strong>XSS:</strong> Malicious script injection</li>
 <li><strong>CSRF:</strong> Cross-site request forgery</li>
 <li><strong>Security Misconfiguration:</strong> Improper server settings</li>
 </ul>

 <h6 class="mt-3">Scan Limitations:</h6>
 <ul class="small">
 <li>Basic pattern matching</li>
 <li>No deep application logic testing</li>
 <li>Limited to common vulnerabilities</li>
 <li>May produce false positives</li>
 </ul>
 </div>
 </div>

 <!-- Risk Levels -->
 <div class="card module-card mt-3">
 <div class="card-body">
 <h6><i class="fas fa-exclamation-triangle"></i> Risk Levels</h6>
 <div class="mb-2">
 <span class="badge bg-danger me-2">Critical</span>
 <small>Immediate action required</small>
 </div>
 <div class="mb-2">
 <span class="badge bg-warning me-2">High</span>
 <small>Address as soon as possible</small>
 </div>
 <div class="mb-2">
 <span class="badge bg-info me-2">Medium</span>
 <small>Should be addressed</small>
 </div>
 <div class="mb-2">
 <span class="badge bg-success me-2">Low</span>
 <small>Monitor and consider fixing</small>
 </div>
 </div>
 </div>
 </div>
 </div>

 <!-- Legal Notice -->
 <div class="alert alert-danger mt-3">
 <h6><i class="fas fa-gavel"></i> Legal and Ethical Notice</h6>
 <p class="mb-2"><strong>IMPORTANT:</strong> Only scan websites you own or have explicit written permission to test.</p>
 <ul class="mb-0">
 <li>Unauthorized vulnerability scanning may be illegal in your jurisdiction</li>
 <li>Always obtain proper authorization before testing</li>
 <li>Use this tool responsibly and ethically</li>
 <li>Report vulnerabilities through responsible disclosure practices</li>
 </ul>
 </div>
 </div>
 </div>
</div>

<script>
function confirmEthicalUse() {
 return confirm("I confirm that I own this website or have explicit written permission to perform security testing. Unauthorized scanning may be illegal.");
}

// HTML escape function to prevent XSS
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Safe createElement helper
function createElementSafe(tag, className = '', textContent = '') {
    const el = document.createElement(tag);
    if (className) el.className = className;
    if (textContent) el.textContent = textContent;
    return el;
}

// AJAX form submission for vulnerability scanner
document.getElementById('vulnerabilityScanForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (!confirmEthicalUse()) {
        return false;
    }
    
    const form = e.target;
    const formData = new FormData(form);
    const url = document.getElementById('vulnerabilityUrl').value;
    
    // Show loading state
    document.getElementById('scanVulnerabilityBtn').disabled = true;
    document.getElementById('vulnerabilitySpinner').style.display = 'block';
    document.getElementById('vulnerabilityResults').style.display = 'none';
    
    fetch(form.action, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        // Check if user needs to authenticate (redirect to login)
        if (response.redirected && response.url.includes('/auth/')) {
            window.location.href = response.url;
            return;
        }
        
        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Server response was not JSON. Please refresh the page and try again.');
        }
        
        // Check for HTTP errors
        if (!response.ok) {
            throw new Error(`Server error: ${response.status} ${response.statusText}`);
        }
        
        return response.json();
    })
    .then(data => {
        // Skip if redirected to auth
        if (!data) return;
        
        // Hide loading state
        document.getElementById('scanVulnerabilityBtn').disabled = false;
        document.getElementById('vulnerabilitySpinner').style.display = 'none';
        
        // Display results
        displayVulnerabilityResults(data, url);
        document.getElementById('vulnerabilityResults').style.display = 'block';
    })
    .catch(error => {
        // Hide loading state
        document.getElementById('scanVulnerabilityBtn').disabled = false;
        document.getElementById('vulnerabilitySpinner').style.display = 'none';
        
        // Show error safely - no XSS vulnerability
        const container = document.getElementById('vulnerabilityResultsContent');
        container.innerHTML = ''; // Clear previous content
        
        const errorDiv = createElementSafe('div', 'alert alert-danger');
        const errorIcon = document.createElement('i');
        errorIcon.className = 'fas fa-exclamation-triangle';
        
        const errorStrong = createElementSafe('strong', '', 'Error: ');
        const errorText = document.createTextNode(error.message || 'An error occurred while scanning the URL.');
        
        errorDiv.appendChild(errorIcon);
        errorDiv.appendChild(document.createTextNode(' '));
        errorDiv.appendChild(errorStrong);
        errorDiv.appendChild(errorText);
        
        container.appendChild(errorDiv);
        document.getElementById('vulnerabilityResults').style.display = 'block';
    });
});

function displayVulnerabilityResults(data, url) {
    const container = document.getElementById('vulnerabilityResultsContent');
    container.innerHTML = ''; // Clear previous content
    
    if (!data.success) {
        container.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> <strong>Error:</strong> ${escapeHtml(data.error || 'An error occurred')}</div>`;
        return;
    }
    
    // Determine status styling
    let statusClass, statusIcon, statusText;
    const riskLevel = (data.risk_level || '').toLowerCase();
    switch(riskLevel) {
        case 'high':
            statusClass = 'danger'; statusIcon = 'fas fa-times-circle'; statusText = 'HIGH RISK';
            break;
        case 'medium':
            statusClass = 'warning'; statusIcon = 'fas fa-exclamation-triangle'; statusText = 'MEDIUM RISK';
            break;
        case 'low':
            statusClass = 'success'; statusIcon = 'fas fa-check-circle'; statusText = 'LOW RISK';
            break;
        default:
            statusClass = 'secondary'; statusIcon = 'fas fa-question-circle'; statusText = 'UNKNOWN RISK';
    }
    
    // Build clean, Bootstrap-based HTML content
    let html = `
        <div class="alert alert-${statusClass} mb-3 p-3">
            <div class="d-flex justify-content-between align-items-center">
                <div><i class="${statusIcon} me-2"></i><strong>${statusText}</strong></div>
                <small class="text-muted">${escapeHtml(url)}</small>
            </div>
            <div class="d-flex justify-content-between small mt-2">
                <span>Risk Level: ${(data.risk_level || 'Unknown').toUpperCase()}</span>
                <span>Vulnerabilities Found: ${data.vulnerability_count || 0}</span>
            </div>
        </div>
        <div class="row g-3">
            <div class="col-md-6">
                <div class="card border-${data.vulnerabilities && data.vulnerabilities.length > 0 ? 'danger' : 'success'} h-100">
                    <div class="card-header bg-${data.vulnerabilities && data.vulnerabilities.length > 0 ? 'danger' : 'success'} text-white py-2">
                        <small>${data.vulnerabilities && data.vulnerabilities.length > 0 ? '🚨 Security Vulnerabilities' : '✅ Security Status'}</small>
                    </div>
                    <div class="card-body p-3">
    `;
    
    if (data.vulnerabilities && data.vulnerabilities.length > 0) {
        html += '<ul class="mb-0 small">';
        data.vulnerabilities.forEach(vuln => {
            html += `<li class="mb-1">${escapeHtml(String(vuln))}</li>`;
        });
        html += '</ul>';
    } else {
        html += '<p class="mb-0 small text-success">No obvious vulnerabilities detected.</p>';
    }
    
    html += `
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card border-secondary h-100">
                    <div class="card-header bg-secondary text-white py-2">
                        <small>📋 Security Analysis</small>
                    </div>
                    <div class="card-body p-3">
    `;
    
    // Security Issues with proper formatting
    if (data.security_issues && data.security_issues.length > 0) {
        html += '<div class="mb-3"><h6 class="text-danger mb-2">⚠️ Security Issues</h6>';
        html += '<ul class="list-unstyled small">';
        data.security_issues.forEach(issue => {
            html += `<li class="text-danger mb-1">• ${escapeHtml(String(issue))}</li>`;
        });
        html += '</ul></div>';
    }
    
    // Security Strengths with proper formatting
    if (data.security_strengths && data.security_strengths.length > 0) {
        html += '<div class="mb-3"><h6 class="text-success mb-2">✅ Security Strengths</h6>';
        html += '<ul class="list-unstyled small">';
        data.security_strengths.forEach(strength => {
            html += `<li class="text-success mb-1">• ${escapeHtml(String(strength))}</li>`;
        });
        html += '</ul></div>';
    }
    
    // Security Headers with proper formatting
    const hasHeaders = (data.missing_headers && data.missing_headers.length > 0) || 
                      (data.present_headers && data.present_headers.length > 0);
    
    if (hasHeaders) {
        html += '<div><h6 class="text-info mb-2">🔒 Security Headers</h6>';
        
        if (data.missing_headers && data.missing_headers.length > 0) {
            html += '<div class="small mb-2"><strong class="text-warning">Missing:</strong><br>';
            html += '<span class="text-muted">' + data.missing_headers.map(h => escapeHtml(String(h))).join(', ') + '</span></div>';
        }
        
        if (data.present_headers && data.present_headers.length > 0) {
            html += '<div class="small"><strong class="text-success">Present:</strong><br>';
            html += '<span class="text-muted">' + data.present_headers.map(h => escapeHtml(String(h))).join(', ') + '</span></div>';
        }
        html += '</div>';
    }
    
    // If no specific data, show general message
    if ((!data.security_issues || data.security_issues.length === 0) && 
        (!data.security_strengths || data.security_strengths.length === 0) && !hasHeaders) {
        html += '<p class="text-muted mb-0">Basic security scan completed. No detailed analysis available.</p>';
    }
    
    html += `
                    </div>
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
}
</script>
{% endblock %}